#!/usr/bin/env bash

PATH="vendor/bin:$PATH"
testport=${E2E_PORT:-"5000"}
testspec=${E2E_SPEC:-"e2e/spec.conf.js"}
testproc=${E2E_PROC:-"heroku-php-nginx -C config/heroku/nginx.conf web"}
# TODO: extract $testproc default from Procfile, if it exists

hash npx 2>/dev/null || { echo >&2 "Unable to find npx in PATH."; exit 1; }
hash chromedriver 2>/dev/null || { echo >&2 "Unable to find chromedriver in PATH."; exit 1; }
[[ -f $testspec ]] ||Â { echo >&2 "No e2e tests defined: $testspec not found."; exit 1; }

PORT=$testport $testproc >/tmp/$$-http-log.txt 2>&1 &
proc_pid=$!

chromedriver >/dev/null 2>&1 &
chromedriver_pid=$!

npx wait-on -l "tcp:$testport"
npx protractor "$testspec" "--baseUrl" "http://localhost:$testport/"
protractor_exit=$?

echo "--- http server log ---"
cat /tmp/$$-http-log.txt
echo "--- http server log ---"

kill $chromedriver_pid $proc_pid
exit $protractor_exit
